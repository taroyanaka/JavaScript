<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8" />
    <title>canvas painter</title>
    <!-- Reference
        https://q-az.net/canvas-drawing-pad/
        https://javascript.programmer-reference.com/js-base64-canvas/
        https://qiita.com/clockmaker/items/924b5b4228484e7a09f0
    -->
</head>

<body>
    <!-- <div id="msg0"></div> -->
    <!-- <div id="msg1"></div> -->
    <!-- <div id="msg2"></div> -->
    <!-- <div id="msg3"></div> -->
    <!-- <div id="msg4"></div> -->
    <!-- <div id="msg5"></div> -->
    <!-- <div id="msg6"></div> -->
    <!-- <div id="msg7"></div> -->

    <canvas id="myCanvas" width="700" height="400"></canvas>
    <div>
        <input type="color" id="color" style="width:200px;height:100px" value="#ffffff">
        <div>
            <input type="range" id="penSize" min="0" max="30" step="1" value="7" style="width:400px;height:200px">
            <span id="penSizeText"></span>
        </div>
        <div>
            <input type="range" id="penTransparency" min="0" max="1" step="0.1" value="1"
                style="width:400px;height:200px">
            <span id="penTransparencyText"></span>
        </div>
    </div>
    <div>
        <input type="button" id="save" value="save" style="width:200px;height:100px" onclick="save()" />
        <input type="button" id="removePaint" value="removePaint" style="width:200px;height:100px"
            onclick="removePaint()" />

        <input type="button" id="showSaveData" value="showSaveData" style="width:200px;height:100px"
            onclick="showSaveData();">
        <input type="button" id="hidePaint" value="hidePaint" style="width:200px;height:100px" onclick="hidePaint();">

        <input type="button" id="removeSaveData" value="removeSaveData" style="width:100px;height:50px"
            onclick="removeSaveData();">
    </div>
    <div></div>
</body>
<script>
    let canvas = document.getElementById('myCanvas');

    let ctx = canvas.getContext('2d');
    ctx.beginPath();
    ctx.fillStyle = "#f5f5f5";
    ctx.fillRect(0, 0, 700, 400);

    canvas.addEventListener('mousemove', onMove, false);
    canvas.addEventListener('mousedown', onClick, false);

    //マウス動いていて、かつ左クリック時に発火。
    function onMove(e) {
        if (e.buttons === 1 || e.witch === 1) {
            let rect = e.target.getBoundingClientRect();
            let X = ~~(e.clientX - rect.left);
            let Y = ~~(e.clientY - rect.top);
            //draw 関数にマウスの位置を渡す
            draw(X, Y);
        };
    };

    //マウスが左クリックされると発火。
    function onClick(e) {
        if (e.button === 0) {
            let rect = e.target.getBoundingClientRect();
            let X = ~~(e.clientX - rect.left);
            let Y = ~~(e.clientY - rect.top);
            //draw 関数にマウスの位置を渡す
            draw(X, Y);
        }
    };

    let defocolor = "#555555";

    function watchColorPicker(event) {
        defocolor = event.target.value;
    }
    document.querySelector("#color").addEventListener("change", watchColorPicker, false);

    let defosize = 7;

    function penSize(event) {
        defosize = event.target.value;
        document.getElementById('penSizeText').textContent = 'defosize:' + defosize;
    }
    document.querySelector("#penSize").addEventListener("change", penSize, false);

    let defoalpha = 1.0;

    function penTransparency(event) {
        defoalpha = event.target.value;
        document.getElementById('penTransparencyText').textContent = 'defoalpha:' + defoalpha;
    }
    document.querySelector("#penTransparency").addEventListener("change", penTransparency, false);



    //マウス継続値の初期値、ここがポイント
    let mouseX = "";
    let mouseY = "";

    //渡されたマウス位置を元に直線を描く関数
    function draw(X, Y) {
        ctx.beginPath();
        ctx.globalAlpha = defoalpha;
        //マウス継続値によって場合分け、直線の moveTo（スタート地点）を決定
        if (mouseX === "") {
            //継続値が初期値の場合は、現在のマウス位置をスタート位置とする
            ctx.moveTo(X, Y);
        } else {
            //継続値が初期値ではない場合は、前回のゴール位置を次のスタート位置とする
            ctx.moveTo(mouseX, mouseY);
        }
        //lineTo（ゴール地点）の決定、現在のマウス位置をゴール地点とする
        ctx.lineTo(X, Y);
        //直線の角を「丸」、サイズと色を決める
        ctx.lineCap = "round";
        ctx.lineWidth = defosize * 2;
        ctx.strokeStyle = defocolor;
        ctx.stroke();
        //マウス継続値に現在のマウス位置、つまりゴール位置を代入
        mouseX = X;
        mouseY = Y;


        // document.getElementById('msg0').innerHTML = 'position X:' + mouseX + ' Y' + mouseY;
        // document.getElementById('msg1').innerHTML = 'defosize:' + defosize;
        // document.getElementById('msg2').innerHTML = 'defocolor:' + defocolor;
        // document.getElementById('msg3').innerHTML = 'defoalpha:' + defoalpha;
        // document.getElementById('msg5').innerHTML = 'datas:' + datas;

    };

    //左クリック終了、またはマウスが領域から外れた際、継続値を初期値に戻す
    function drawEnd() {
        mouseX = "";
        mouseY = "";
    }

    function removePaint() {
        ctx.beginPath();
        ctx.globalAlpha = 1.0;
        ctx.fillStyle = "#f5f5f5";
        ctx.fillRect(0, 0, 700, 400);

        defosize = 7;
        defocolor = "#555555";
        defoalpha = 1.0;

        //マウス継続値の初期値、ここがポイント
        mouseX = "";
        mouseY = "";
    }

    let data;


    if (localStorage.getItem('lkey')) {
        let datas = [];

        ldatas = localStorage.getItem('lkey');
        lArray = JSON.parse(ldatas);
        datas = datas.concat(lArray);
        console.log(datas);
    } else {
        let datas = [];
    }


    function save() {
        data = canvas.toDataURL("image/png");
        // document.getElementById('msg4').innerHTML = 'data:' + data;
        // sessionStorage.setItem('skey', data);
        datas.push(data);
        localStorage.setItem('lkey', JSON.stringify(datas));
    }

    // localStorage.setItem('lkey', 'lvalue');
    // let ldata = localStorage.getItem('lkey');
    // localStorage.removeItem('lkey')

    function showSaveData() {
        // let sdata = sessionStorage.getItem('skey');
        let ldatas = localStorage.getItem('lkey'); // img.src = ldata;
        let lArray = JSON.parse(ldatas);

        // document.getElementById('msg6').innerHTML = 'ldatas:' + ldatas;
        // document.getElementById('msg7').innerHTML = 'lArray:' + lArray;

        lArray.forEach(V => {
            //画像オブジェクトを生成

            let img = new Image();
            img.src = V;
            //画像をcanvasに設定
            img.onload = function () {
                //2Dコンテキストのオブジェクトを生成する
                // let cvs = document.getElementById('cvs1');
                let cvs = document.createElement("canvas");
                cvs.setAttribute("class", "pic");
                cvs.setAttribute("width", "700");
                cvs.setAttribute("height", "400");
                document.querySelector("body").appendChild(cvs);
                let ctx = cvs.getContext('2d');
                ctx.drawImage(img, 0, 0, 700, 400);
            }
        })
    }

    function hidePaint() {
        document.querySelectorAll(".pic").forEach(pic => {
            pic.remove()
        })
    }

    function removeSaveData() {
        if (window.confirm('Do you remove saved pictures, Really??')) {
            localStorage.removeItem('lkey')
            datas = [];
            hidePaint();
        }
    }
</script>
<script>

</script>

</html>