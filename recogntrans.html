<!DOCTYPE html>
<html>
<head>
    <title>recogntrans: recognize and translate</title>
    <!-- v4 -->
    <script src='https://unpkg.com/tesseract.js@4.0.2/dist/tesseract.min.js'></script>
    <!-- <script src='./lib/tesseract@4.0.2.js'></script> -->

<style>
/* en_result_textのtextareaとja_result_textのtextareaをgridで50%と50%の2カラムで表示するCSS */
#en_result_text, #ja_result_text {
    /* width: 30vw; */
    height: 100%;
    resize: none;
    /* border: none; */
    padding: 0;
    margin: 0;
    /* font-size: 16px; */
    font-family: monospace;
    line-height: 1.5;
    overflow: auto;
}
/* grid_parentでgrid_parentの子要素を3カラムで表示 */
#grid_parent {
    display: grid;
    grid-template-columns: 0fr 1fr 1fr;
    grid-template-rows: 1fr;
    grid-template-areas: "ja_text en_result_text ja_result_text";
}

/* imgタグを10rem10remで表示する */
#image {
    width: 10rem;
    height: 10rem;
}
</style>
</head>


<!-- https://qiita.com/satto_sann/items/be4177360a0bc3691fdf -->
<script id="google_apps_script">
// function doGet(e) {
//     var p = e.parameter;
// function sleep(waitMsec) {
//     var startMsec = new Date();
//     while (new Date() - startMsec < waitMsec);
// }
// function json_string_to_array(json_string) {
//     return JSON.parse(json_string);
// }
// var ary = json_string_to_array(p.text);
// function translate_array(array) {
//     let translated_array = [];
//     for (let i = 0; i < array.length; i++) {
//         let element = array[i];
//         sleep(500);
//         translated_array.push(LanguageApp.translate(element, p.source, p.target));
//     }
//     return translated_array;
// }
// var res = translate_array(ary);
// function array_to_json_string(array) {
//     return JSON.stringify(array);
// }
// var translatedTextJSON_Str = array_to_json_string(res);
//     var body;
//     if (translatedTextJSON_Str) {
//         body = {
//           code: 200,
//           text: translatedTextJSON_Str
//         };
//     } else {
//         body = {
//           code: 400,
//           text: "Bad Request"
//         };
//     }
//     var response = ContentService.createTextOutput();
//     response.setMimeType(ContentService.MimeType.JSON);
//     response.setContent(JSON.stringify(body));
//     return response;
// }
</script>


<body>
    <h1>recognize with Tesseract.js</h1>
    <img id="image" src="">
    <pre id="text"></pre>
<!-- <button onclick="execute()">execute</button> -->
<button onclick="next_page()">next_page</button>

<div id="progress"></div>

<button onclick="setup_data()">setup_data</button>
<button onclick="translateText()">translateText</button>

<h1>google apps script 翻訳の元データ</h1>
<p>urls = ['sample_img_url1.jpg', 'sample_img_url2.jpg', 'sample_img_url3.jpg'];</p>
<p>page_number = 1;</p>
<p>limit_word_volume = 5;</p>
<p>の値を変更して利用する</p>

<!-- <button onclick="set_ja_text()">set_ja_text</button> -->

<div id="grid_parent">
<div id="ja_text"></div>
<textarea name="" cols="30" rows="1000" id="en_result_text"></textarea>
<textarea name="" cols="30" rows="1000" id="ja_result_text"></textarea>
</div>

<script>
json_string_url = 'https://gist.githubusercontent.com/taroyanaka/acacbb47f5504f9ce70229e13a8d6117/raw/c18f1d481948f9145e4ad51dba120d71966950b7/book_data.json';

urls = ['sample_img_url1.jpg', 'sample_img_url2.jpg', 'sample_img_url3.jpg'];
async function url_data_fetch() {
  try {
    const response = await fetch(json_string_url);
    const data = await response.json();
    // console.log(data);
    return JSON.parse(data);
  } catch (error) {
    // console.error(error);
  }
}
(async function() {
  urls = await url_data_fetch();
})();

page_number = 1;
limit_word_volume = 5;

let data = null;
let test = null;
let test2 = null;



function paging_from_urls_array(urls_array) {
    let paging = [];
    for (let i = 0; i < urls_array.length; i++) {
        let url = urls_array[i];
        paging.push(url);
    }
    return paging;
}

let page = null;
function next_page(){
    page_number++;
    page = paging_from_urls_array(urls)[page_number];
    execute();
}


// 画像の読み込み
function execute(){
    const img = document.getElementById('image');
    img.src = page;
    // 進捗表示用の要素を取得
    const progressEl = document.getElementById('progress');
    // Tesseract.jsの処理中に進捗を表示するコールバック関数
    const progressFn = (progress) => {
        // 進捗状況を整形して表示
        progressEl.innerText = `進捗: ${progress.progress}% (${progress.status})`;
    };
    //   Tesseract.recognize('https://tesseract.projectnaptha.com/img/eng_bw.png', 'eng', { logger: progressFn })
    Tesseract.recognize(img, 'eng', { logger: progressFn })
        .then(result => {
        data = result;
        console.log(result);
        // 抽出されたテキストをHTMLページに出力
        // document.getElementById('text').innerText = result.text;
        document.getElementById('text').innerText = result.data.text;
    });
}


// スペースか改行で区切られた文字列を配列に変換
function split_string_to_array(str) {
    return str.split(/[\s]+/);
}




function setup_data(){
    sample_text = document.getElementById('text').innerText
    result = split_string_to_array(sample_text);

    // resultを改行した文字列に変換してlines_resultに代入する関数を1行で書く
    joined_result = result.join("\n");
    // textareaにlines_resultを代入
    document.getElementById('en_result_text').value = joined_result;

    // 配列のそれぞれが文字列の要素をdivタグに変換する関数
    function array_to_div(array) {
        let div = "";
        for (let i = 0; i < array.length; i++) {
            let element = array[i];
            div += `<div>${element}</div>`;
        }
        return div;
    }

    // ja_textにlines_resultを代入
    document.getElementById('ja_text').innerHTML = array_to_div(result);

    // 3秒後にja_textをja_result_textに代入する関数
    function set_ja_text() {
        document.getElementById('ja_result_text').value = document.getElementById('ja_text').innerText;
    }
    set_ja_text();
    // 3秒後にja_textをja_result_textに代入
    // setTimeout(googleTranslateElementInit, 3000);
}

// fetchのサンプルコード
// ?text=Hello&source=en&target=ja がパラメーター
function translateText() {
    const text = array_to_json_string(document.getElementById('en_result_text').value.split("\n")
.slice(0, limit_word_volume)
);
    const source = 'en';
    const target = 'ja';
    const endpoint = 'https://script.google.com/macros/s/AKfycbzZuVNS36WugiFnBLpNYVEHdC5DicIxZYZWpfTFGXj_6UusY6H-7Z6IdKdKnLg7kcey/exec';
    const url = test2 = endpoint + `?text=` + text + `&source=${source}&target=${target}`;
    fetch(url)
        .then(response => response.json())
        .then(json => {
test = json_string_to_array(json.text);
            document.getElementById('ja_result_text').value = json_string_to_array(json.text).join("\n");
        });
}

// 配列をJSON.stringifyで文字列に変換する関数
function array_to_json_string(array) {
    return JSON.stringify(array);
}
// JSON文字列をJSON.parseで配列に変換する関数
function json_string_to_array(json_string) {
    return JSON.parse(json_string);
}


// var translatedText = LanguageApp.translate(p.text, p.source, p.target);
// という処理を配列のそれぞれの要素に対して行う関数に書き換える
// function translate_array(array) {
//     let translated_array = [];
//     for (let i = 0; i < array.length; i++) {
//         let element = array[i];
//         translated_array.push(LanguageApp.translate(element, 'en', 'ja'));
//     }
//     return translated_array;
// }


</script>




</body>
</html>
