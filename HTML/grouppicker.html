<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>grouppicker</title>
    <style>
        .checkbox-1{
            width: 30px;
            height: 30px;
        }
        .exe{
            width: 40px;
            height: 40px;
        }
    </style>
    <script src="localforage.js"></script>
</head>
<body>
<script>
    localforage.config({
        size: 5000
        // => limit size 5kb
    });
</script>

volume:<div class="res"></div>
shuffle:<input type="checkbox" class="checkbox-1" checked>
<input type="button" value="ðŸ”„" class="exe" onclick="exe()">

<div class="copy-parent">
<textarea class="target textarea-1" cols="10" rows="5" oninput="addOption();"></textarea>
<textarea class="target textarea-2" cols="10" rows="5" oninput="addOption();"></textarea>
<textarea class="target textarea-3" cols="10" rows="5" oninput="addOption();"></textarea>
</div>
<input type="button" value="addTextarea" onclick="addTextarea();">


<div class="test"></div>

<div class="paste-parent">
</div>
<script>
async function getData() {
    return await fetch()
        .then(response=>response.text())
        // .catch(err=> document.querySelector(".text").value = err);
}
async function testSave(){
    const data = await getData();
    await localforage.setItem(memory, JSON.stringify(data))
        // .then(res=> document.querySelector(".text").value = JSON.parse(res))
        // .catch(err=> document.querySelector(".text").value = err);
}
async function testLoad(){
// try {
    const value = await localforage.getItem();
    const res = value ? JSON.parse(value) : "db is null";
    document.querySelector(".text").value = res;
    // }
    // catch (err) {    document.querySelector(".text").value = err    }
}


const addTextarea = () =>{
    let tmp=[];
    Array.from(document.querySelectorAll(".copy-parent > *")).forEach((V,IDX)=>
        tmp.push(V.value)
    );
    document.querySelector(".copy-parent").innerHTML += `<textarea class="target textarea-${(document.querySelectorAll(".copy-parent > .target").length + 1)}" cols="10" rows="5" oninput="addOption();"></textarea>`;
    addOption();
    tmp.forEach((V,IDX)=>
        document.querySelectorAll(".copy-parent > *")[IDX].value = V
    );
    addOption();
}

const init = () =>{
    document.querySelector('.textarea-1').value = `0-1
0-2`;
    document.querySelector('.textarea-2').value = `1-1
1-2
1-3`;
    document.querySelector('.textarea-3').value = `2-1
2-2`;
}
init();


const addOption = () =>{
    document.querySelector('.res').innerHTML = 
        Array.from(document.querySelectorAll(".copy-parent >.target"))
            .map((V,OUTERIDX)=>{
            return V.value.split("\n").map((VAL,IDX,ARY)=>{
                const header = IDX === 0 ? `<select class="num res-${OUTERIDX}" onchange="exe()">` : "";
                const footer = IDX === (ARY.length - 1) ? `</select>` : "";
                return header + `<option value="${IDX+1}">${IDX+1}</option>` + footer;
            }).join("")
        }).join("");

    Array.from(document.querySelectorAll(".num")).forEach(V=>V[(V.length - 1)].selected = true);
}
addOption();

// document.querySelector('.test').innerText = document.querySelectorAll(".num")[1].value;
const shuffleArray = array => {
    for (let i = array.length - 1; i > 0; i--) {
    let r = Math.floor(Math.random() * (i + 1));
    let tmp = array[i];
    array[i] = array[r];
    array[r] = tmp;
    }
    return array
}
const exe = () =>{
    document.querySelector(".paste-parent").innerHTML =
        document.querySelector(".copy-parent").innerHTML;

    Array.from(document.querySelectorAll(".paste-parent > *")).forEach((V,IDX)=>
        V.value =
            document.querySelectorAll(".copy-parent > *")[IDX].value
                .split("\n")
                .reduce((A,V,IDX,ARY)=>{
                    A = document.querySelector(".checkbox-1").checked ? shuffleArray(ARY) : ARY;
                    return A;},A=[])
                .filter((VAL,INDEX)=>
                    INDEX < document.querySelectorAll(".num")[IDX].value
                )
                .join("\n")
    )

    // Array.from(document.querySelectorAll(".paste-parent > *"))[0].value =
    //     Array.from(document.querySelectorAll(".num"))[0].value;

    // document.querySelectorAll(".copy-parent > *").forEach((V,IDX)=>{
    // document.querySelectorAll(".paste-parent > *")[IDX].value =
    //     V.value
    //         .split("\n")
    //         .filter((V,INDEX)=>
    //             INDEX<=Number(document.querySelectorAll(".num")[IDX].value) )
    // });
}

exe();
</script>
</body>
</html>