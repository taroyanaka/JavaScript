<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>fill-in-the-blank-multiple-choice-question</title>
    <!-- <script src="ramda.js"></script> -->
    <script src="localforage.js"></script>
    <style>
        button{
            height: 3rem;
        }
        .seedNum{
            width: 3rem;
        }
    </style>
</head>

<body>
<button class="collapseChanger" onclick="collapseChanger()">collapseChanger</button>
<div class="collapse">
    <input type="number" name="seedNum" class="seedNum" value="42" onchange="changer()">
    <textarea name="question" class="question" cols="100" rows="10" oninput="changer();checker();"></textarea>
    <textarea name="changer" class="changer" cols="100" rows="10" oninput="changer();checker();"></textarea>
</div>
    <div class="answer"></div>
<script>
const collapseChanger = () => {
    const collapseStyle = document.querySelector(`.collapse`).style;
    if(collapseStyle.visibility === "hidden"){
        collapseStyle.visibility = "visible";
        collapseStyle.height = collapseStyle.width = "";
    }else{
        collapseStyle.visibility = "hidden";
        collapseStyle.width = collapseStyle.height = 0;
    }
};
const mixAnswer = (ARY, ANSWER) => ARY;
const makeOptionTag = (ARY) => `<option value="" selected></option>` + ARY.map(VAL=>`<option value="${VAL}">${VAL}</option>`).join("");
const makeSelectTag = (ARY, ANSWER) => {
return `<select class="blank" data-answer="${ANSWER}" onchange="checker();">
${makeOptionTag(ARY)}
</select>`;
};
const initer = () => {
    document.querySelector(".question").value = `foo bar baz is foo bar baz
and foo2 bar2 baz3 is foo2 bar2 baz3
or foo2bar2baz3isfoo2bar2baz3
or not
and foo2 qux bar2 baz3 qux2 is foo2 bar2 baz3qux3 
or foo2barQUX42baz3isfoo2bar2baz3
日本語は自然言語のうちの一つで主に日本国内で使われています`;
    document.querySelector(".changer").value = `foo
qux
日本
blabla
yes
😄yes😄
no`;
};
const changer = () => {
    // https://stackoverflow.com/a/1234725
    const regex = "(" + document.querySelector(".changer").value.split("\n").map(V=>`${V}|`).join("").slice(0, -1) + ")";
    const RE = new RegExp(regex, "gm");
    document.querySelector(".answer").innerHTML =
                document.querySelector(".question").value.replaceAll(
                    RE,
                    makeSelectTag(
                        document.querySelector(".changer").value.split("\n"),
                        "$1"
                    )
                )
                .replaceAll(
                    "\n",
                    `</br>`);
    narrowDownAnswer();
};
const tester = () => {
    document.querySelectorAll(".blank")[0].value = "foo";
    document.querySelectorAll(".blank")[1].value = "qux";
    document.querySelectorAll(".blank")[10].value = "qux";
    document.querySelectorAll(".blank")[14].value = "日本";
};
const checkWithValueToAnswer = (BLANK_ELEMENT, IDX) => {
    // console.log("OK or NG")
    // BLANK_ELEMENT.value === BLANK_ELEMENT.dataset.answer ? console.log(`${IDX} is OK`) : console.log(`${IDX} is NG`);
    // change backgroundColor
    BLANK_ELEMENT.value === BLANK_ELEMENT.dataset.answer ? BLANK_ELEMENT.style.backgroundColor = "" : BLANK_ELEMENT.style.backgroundColor = "red";
}
const checker = () => {
    document.querySelectorAll(".blank").forEach((BLANK_ELEMENT, IDX) => {
        checkWithValueToAnswer(BLANK_ELEMENT, IDX)
    })
};
function random(seed) {
    const x = Math.sin(seed++) * 10000;
    return x - Math.floor(x);
}
function seedShuffle(array, seed) {
    let m = array.length, t, i;
    while (m) {
        i = Math.floor(random(seed) * m--);
        t = array[m];
        array[m] = array[i];
        array[i] = t;
        ++seed
    }
    return array;
}
const narrowDownAnswer = () => {
    let SEED = Number(document.querySelector(`.seedNum`).value);
    const seedIncrement = () => SEED++;
    document.querySelectorAll(".blank").forEach(SELECT_HTML_ELEMENT=>{
        const OPTION_HTML_ELEMENT = SELECT_HTML_ELEMENT.children;
        const answerOption = Array.from(OPTION_HTML_ELEMENT)
            .filter(V => V.innerText !== "")
            .filter(V => V.innerText === SELECT_HTML_ELEMENT.dataset.answer);
        const shuffledWithoutBlankOptionWithoutAnswerOption = seedShuffle(
                Array.from(OPTION_HTML_ELEMENT)
                    .filter(V => V.innerText !== "")
                    .filter(V => V.innerText !== SELECT_HTML_ELEMENT.dataset.answer)
                , seedIncrement()
            )
            .slice(0, 2);
        const answerAntNotAnswerOptionArray = answerOption.concat(shuffledWithoutBlankOptionWithoutAnswerOption);
        const shuffledAnswerAntNotAnswerOptionArray = seedShuffle(
            answerAntNotAnswerOptionArray,
            seedIncrement());
        const shuffledAnswerAndNotAnswerOptionHTMLString = shuffledAnswerAntNotAnswerOptionArray
            .map(V => V.outerHTML)
            .join("");
        const blankOptionHTMLTagString = `<option value="" selected></option>`;
        const blankAndShuffledAnswerAndNotAnswerOptionHTMLString = blankOptionHTMLTagString + shuffledAnswerAndNotAnswerOptionHTMLString;
        SELECT_HTML_ELEMENT.innerHTML = blankAndShuffledAnswerAndNotAnswerOptionHTMLString;
    })
};

initer();
changer();
tester();
checker();
narrowDownAnswer();

const saveAndLoad = async () => {
    await localforage.setItem("foo", JSON.stringify([0,1,2]));
    await localforage.getItem("foo");
    const foo = await localforage.getItem("foo");
    console.log(typeof JSON.parse(foo)[0]);
    const bar = await localforage.keys();
    console.log(bar);
    const NUM = 0
    const buz = location.href + "_" + NUM.toString();
    await localforage.setItem(buz, JSON.stringify([10,20,30]));
};
</script>
</body>
</html>