<!DOCTYPE html>
<html lang="ja">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>foo</title>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script> -->
    <!-- <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script> -->

    <!-- <script src="https://www.gstatic.com/firebasejs/6.0.2/firebase.js"></script> -->
    <script src="firebase-app.js"></script>
    <script src="firebase-firestore.js"></script>

    <script>
        firebase.initializeApp({
            projectId: "yanaka-7bb50"
        });
    </script>
    <style>
        div {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <input type="button" value="DeleteAll" onclick="deleteAllDocuments()">
    <div id="foo">hoge</div>
    <form name="form1" onsubmit="createText()">
        <input type="text" name="text1" size="30" maxlength="4">
        <input type="submit" value="GO!" />
    </form>
</body>

<script type="text/javascript">
    // https://qiita.com/Bosch_san/items/e3e06acdb3c7b53553f2

    // store resource from "chache"
    function cacheOn() {
        firebase.firestore().enablePersistence({
            synchronizeTabs: true
        })
        storeResource = {
            source: "cache"
        };
    }

    function create() {
        firebase.firestore().collection("users").add({
            foo: "bar",
            foo2: "bar2"
        }).then(docRef => {
            location.reload();
            console.log("Document written with ID: ", docRef.id);
        }).catch(error => {
            console.error("Error adding document: ", error);
        });
    }

    function createText() {
        document.form1.text1.value === "" ? text = "test" : text = document.form1.text1.value;
        firebase.firestore().collection("users").add({
            foo: "bar",
            // foo2: `${document.form1.text1.value}`
            foo2: `${text}`
        }).then(docRef => {
            console.log("Document written with ID: ", docRef.id);
        }).catch(error => {
            console.error("Error adding document: ", error);
        });
    }

    // DOM append
    function append(text, id) {
        let div = document.createElement('div');
        div.textContent = text;
        div.setAttribute("id", id);
        document.querySelector('body').appendChild(div);
    }

    function read() {
        firebase.firestore().collection("users").get(
            storeResource
        ).then(col => {
            col.forEach(doc => {
                console.log(`${doc.id} => ${doc.data().foo2}`);
                append(`${doc.data().foo2}`, doc.id);
            });
        })
    }

    // READ collection, document, field, append Delete function to div elements
    function readAndAppendDelete() {
        firebase.firestore().collection("users").get(
            storeResource
        ).then(col => {
            col.forEach(doc => {
                console.log(`${doc.id} => ${doc.data().foo2}`);
                append(`${doc.data().foo2}`, doc.id);
            });
        }).then(() => {
            // append Delete function to div elements
            document.querySelectorAll("div").forEach(e => {
                e.addEventListener("click", deleteDocument, false)
            });
        })
    }

    function update() {
        firebase.firestore().collection("users").doc("DYDZjsIUFYxPvi5QTARH").update({
            foo2: "hogehoge"
        }).then(() => {
            console.dir("UPDATE SUCCESS");
        });
    }

    function deleteDocument(e) {
        firebase.firestore().collection("users").doc(e.target.id).delete().then((result) => {
            console.dir("SUCCESS")
        }).then(function () {
            location.reload();
        }).catch(function (error) {
            console.error("ERROR: ", error);
        });
    }

    function deleteField() {
        firebase.firestore().collection("users").doc("2").update({
            foo: firebase.firestore.FieldValue.delete()
        });
    }

    function deleteAllDocuments() {
        firebase.firestore().collection("users").get().then(col => {
            col.forEach(doc => {
                firebase.firestore().collection("users").doc(
                    `${doc.id}`
                ).delete().then((result) => {
                    console.dir("SUCCESS");
                    location.reload();
                }).catch(function (error) {
                    console.error("ERROR: ", error);
                });
            });
        });
        // DELETE collection is no API, use DELETE each document
    }

    async function db() {
        storeResource = await {
            source: "server"
        };
        await cacheOn();
        // console.dir(firebase.firestore());
        // await create();
        // await update();
        // await read();
        await readAndAppendDelete();
        // deleteDocument();
        // deleteField();
        // await deleteAllDocuments();
    }
    document.addEventListener('DOMContentLoaded', db, false);
</script>

</html>