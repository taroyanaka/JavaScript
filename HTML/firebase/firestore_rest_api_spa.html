<!DOCTYPE html>
<html lang="ja">

<head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8">
    <title>foo</title>
    <!-- <script src="https://www.gstatic.com/firebasejs/5.5.2/firebase.js"></script> -->
    <script src="https://www.gstatic.com/firebasejs/5.8.4/firebase.js"></script>
    <script>
        firebase.initializeApp({
            projectId: "yanaka-7bb50"
        });
    </script>
    <style>
        div {
            cursor: pointer;
        }
    </style>
</head>

<body>


    <div id="foo">hoge</div>
</body>

<script type="text/javascript">
    // https://qiita.com/Bosch_san/items/e3e06acdb3c7b53553f2



    // firebase.firestore().settings({
    //     timestampsInSnapshots: true
    // });

    // import firebase from 'firebase';
    // import 'firebase/firestore';

    // const config = {
    //     /* firebase config */
    // };
    // firebase.initializeApp(config);

    // const firestore = firebase.firestore();



    function create() {
        firebase.firestore().collection("users").add({
            foo: "bar",
            foo2: "bar2"
        }).then(docRef => {
            console.log("Document written with ID: ", docRef.id);
        }).catch(error => {
            console.error("Error adding document: ", error);
        });
    }

    // DOM append
    function append(text, id) {
        let div = document.createElement('div');
        div.textContent = text;
        div.setAttribute("id", id);
        document.querySelector('body').appendChild(div);
    }

    function read() {
        firebase.firestore().collection("users").get({
            source: "cache"
        }).then(col => {
            col.forEach(doc => {
                console.log(`${doc.id} => ${doc.data().foo2}`);
                // append(`${doc.data().foo2}`);
                append(`${doc.data().foo2}`, doc.id);
                // console.table(Object.keys(doc.data()));
            });
        })
    }

    // READ collection, document, field, append Delete function to div elements
    function readAndAppendDelete() {
        firebase.firestore().collection("users").get({
            source: "cache"
        }).then(col => {
            col.forEach(doc => {
                console.log(`${doc.id} => ${doc.data().foo2}`);
                // append(`${doc.data().foo2}`);
                append(`${doc.data().foo2}`, doc.id);
                // console.table(Object.keys(doc.data()));
            });
        }).then(() => {
            // append Delete function to div elements
            document.querySelectorAll("div").forEach(e => {
                e.addEventListener("click", deleteDocument, false)
            });
        })
    }

    function update() {
        firebase.firestore().collection("users").doc("DYDZjsIUFYxPvi5QTARH").update(
            // { foo2: "bar"} → { foo2: "hogehogehoge" }
            {
                foo2: "hogehoge"
            }
        ).then(() => {
            console.dir("UPDATE SUCCESS");
        });
    }

    function deleteDocument(e) {
        // firebase.firestore().collection("users").doc("x1fNOtjiJ0qmYoTtYxrg").delete().then((result) => {
        firebase.firestore().collection("users").doc(e.target.id).delete().then((result) => {
            console.dir("SUCCESS")
        }).catch(function (error) {
            console.error("ERROR: ", error);
        });
    }

    function deleteField() {
        firebase.firestore().collection("users").doc("2").update({
            foo: firebase.firestore.FieldValue.delete()
        });
    }

    function deleteAllDocuments() {
        firebase.firestore().collection("users").get().then(col => {
            col.forEach(doc => {
                firebase.firestore().collection("users").doc(
                    `${doc.id}`
                ).delete().then((result) => {
                    console.dir("SUCCESS")
                }).catch(function (error) {
                    console.error("ERROR: ", error);
                });
            });
        });
        // DELETE collection is no API, use DELETE each document
    }

    async function db() {
        await firebase.firestore().enablePersistence({
            experimentalTabSynchronization: true
        }).then(() => {
            console.log("マルチタブでオフラインデータが使えるよ！");
        });
        // console.dir(firebase.firestore());
        // await create();
        // update();
        // await read();
        await readAndAppendDelete();
        // deleteDocument();
        // deleteField();
        // await deleteAllDocuments();
    }
    document.addEventListener('DOMContentLoaded', db, false);
</script>

</html>