<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>memo</title>
    <script src="localforage.js"></script>
    <script>
        localforage.config({
            size: 10000
        });
    </script>
</head>
<body>
<div class="res"></div>

<button class="add" onclick="add();">add</button>
<button class="load" onclick="load();">load</button>
<button class="clear" onclick="clear();">clear</button>

<div>
<button class="test1" onclick="test1();">test1</button>
<button class="test2" onclick="test2();">test2</button>
</div>

<script>
const add = () => {
    const data = Array.from(document.querySelectorAll(".res > div > .memo")).map(V => V.value);
    document.querySelector(".res").innerHTML +=
        `<div data-tag="">
        <input type="text" name="" class="memo" oninput="save();">
        <span class="remove" onclick="remove(event)">delete</span>
        <input type="text" name="inputTag" class="inputTag">
        <span class="addTag" onclick="addTag(event)">addTag</span>
        <span class="tag"></span>
        </div>`;
    document.querySelectorAll(".memo").forEach((V, IDX)=>
        V.value = data[IDX]? data[IDX] : "" );
};

const remove = (event) => {
    event.target.parentElement.innerHTML = "";
    save();
};
const clear = () => localforage.clear();

async function save() {
    const data = Array.from(document.querySelectorAll(".res > div > .memo")).map(V => V.value);
    await localforage.setItem("memo", JSON.stringify(data))
}
async function load() {
    try {
        const memo = await localforage.getItem("memo");
        const data = JSON.parse(memo);
        data.forEach(V => add());
        document.querySelectorAll(".memo").forEach((V, IDX) => V.value = data[IDX]);
    
        test1_1(0, ["foo"]);
        test1_1(1, ["foo","bar"]);
        test1_1(2, ["baz"]);
        test2();
    } catch (err) {
        console.log(err);
    }
}
document.querySelector(".load").click();

const getParam = (KEY) => (new URL(document.location)).searchParams.get(KEY);
const getTagParam = () => getParam("tag");
const tagParamSplit = () => getTagParam().split(",");

const test1_1 = (NUM, TAG_ARY) => {
    document.querySelectorAll("div.res > *")[NUM].dataset.tag += TAG_ARY.join(",");
    TAG_ARY.forEach(TAG_ARY_VAL=>
        document.querySelectorAll("div.res > *")
            [NUM]
            .querySelector(".tag").innerHTML +=
                `<a href='${window.location.href.includes("?tag=") ? window.location.href + "," + TAG_ARY_VAL : window.location.href + "?tag=" + TAG_ARY_VAL}'>${TAG_ARY_VAL}</a>`);
}

const test2 = () => {
    document.querySelector("div.res").innerHTML = 
        Array.from(document.querySelectorAll("div.res > div"))
            .filter(V =>
                V.dataset.tag.split(",")
                    .some(VAL=>
                        tagParamSplit().includes(VAL) ))
            .map(V => V.outerHTML)
            .join("");
}
</script>
</body>
</html>