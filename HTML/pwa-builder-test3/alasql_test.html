<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="./vue3.js"></script>
    <script src="./localforage.js.v1.10.0.js"></script>
    <script src="./alasql.v1.7.3.js"></script>
    <title>alasql_test</title>
</head>
<body>
<script>
const blog = {
    "article": "foo0",
    "comment_text": "foo2 is FOO2",
    "new_tag": "FOO1",
    "tag_all": [
        "FOO",
        "BAR",
        "BUZ",
        "QUX"
    ]
};
const article_lists = {
    "no_filter_list": [
        {
            "id": 1,
            "article": "bar",
            "tag_list": [
                "QUX"
            ],
            "comment_list": [
                {
                    "comment": "bar is BAR"
                }
            ],
            "star_count": 0,
            "comment_count": 1,
            "article_length": 3,
            "match_score": 0
        },
        {
            "id": 3,
            "article": "vlahvlah!",
            "tag_list": [],
            "comment_list": [],
            "star_count": 0,
            "comment_count": 0,
            "article_length": 9,
            "match_score": 0
        },
        {
            "id": 4,
            "article": "日本語　にニほんホンゴご　ﾆﾎﾝｺﾞ",
            "tag_list": [],
            "comment_list": [],
            "star_count": 0,
            "comment_count": 0,
            "article_length": 18,
            "match_score": 0
        },
        {
            "id": 2,
            "article": "foo\nbar\nBUZ",
            "tag_list": [
                "BAR",
                "QUX"
            ],
            "comment_list": [],
            "star_count": 1,
            "comment_count": 0,
            "article_length": 11,
            "match_score": 0
        },
        {
            "id": 0,
            "article": "foo0",
            "tag_list": [
                "FOO",
                "BAR"
            ],
            "comment_list": [
                {
                    "comment": "foo is FOO"
                },
                {
                    "comment": "foo is not BAR"
                },
                {
                    "comment": "foo2 is FOO2"
                }
            ],
            "star_count": 3,
            "comment_count": 3,
            "article_length": 4,
            "match_score": 0.0055427373972876705
        }
    ],
    "search": "is",
    "sort_by": "star_count",
    "sort_asc_or_desc": false,
    "editing": 0,
    "list": [
        {
            "id": 0,
            "article": "foo0",
            "tag_list": [
                "FOO",
                "BAR"
            ],
            "comment_list": [
                {
                    "comment": "foo is FOO"
                },
                {
                    "comment": "foo is not BAR"
                },
                {
                    "comment": "foo2 is FOO2"
                }
            ],
            "star_count": 3,
            "comment_count": 3,
            "article_length": 4,
            "match_score": 0.0055427373972876705
        }
    ],
    "tmpList": [
        {
            "id": 0,
            "article": "foo0",
            "tag_list": [
                "FOO",
                "BAR"
            ],
            "comment_list": [
                {
                    "comment": "foo is FOO"
                },
                {
                    "comment": "foo is not BAR"
                },
                {
                    "comment": "foo2 is FOO2"
                }
            ],
            "star_count": 3,
            "comment_count": 3,
            "article_length": 4,
            "match_score": 0.0055427373972876705
        }
    ],
    "selected": "",
    "tag_filter_with_OR_selection": [
        "FOO"
    ]
}
</script>
<script>
const article_lists_create_table = () => {
alasql(`CREATE TABLE IF NOT EXISTS article_lists_table (
id INT PRIMARY KEY,
article TEXT,
search_txt TEXT,
sort_by TEXT,
sort_asc_or_desc BOOLEAN,
editing INT,
star_count INT,
comment_count INT,
article_length INT,
match_score INT)`);


}
// const tag_create_table = () => {
// alasql(`CREATE TABLE IF NOT EXISTS tag_table (
// id INT PRIMARY KEY,
// no_filter_list_table_id INT REFERENCES no_filter_list_table(id),
// tag TEXT)`);
// }
const tag_create_table = () => {
alasql(`CREATE TABLE IF NOT EXISTS tag_table (
id INT PRIMARY KEY,
article_lists_table_tag_table_id INT REFERENCES article_lists_table_tag_table(id),
tag TEXT)`);
}

const article_lists_table_tag_table_create_table = () => {
alasql(`CREATE TABLE IF NOT EXISTS article_lists_table_tag_table (
id INT PRIMARY KEY,
article_lists_table_id INT,
tag_table_id INT)`);
}

const comment_create_table = () => {
alasql(`CREATE TABLE IF NOT EXISTS comment_table (
id INT PRIMARY KEY,
no_filter_list_table_id INT REFERENCES no_filter_list_table(id),
comment TEXT)`);
}
const no_filter_list_create_table = () => {
alasql(`CREATE TABLE IF NOT EXISTS no_filter_list_table (
id INT PRIMARY KEY,
article TEXT,
star_count INT,
comment_count INT,
article_length INT,
match_score NUMBER
)`);
}


const article_lists_table1 = [{
id: 1, 
article: "foo1", 
search_txt: "foo1", 
sort_by: "foo1", 
sort_asc_or_desc: true, 
editing: 0, 
star_count: 1, 
comment_count: 3, 
article_length: 3, 
match_score: 0
}];

const no_filter_list_table1 = [
{
id: 1,
article: "foo0",
star_count: 3,
comment_count: 1,
article_length: 4,
match_score: 0.1,
},
{
id: 2,
article: "bar",
star_count: 0,
comment_count: 1,
article_length: 3,
match_score: 0.2,
},
];

article_lists_create_table();
alasql('SELECT * INTO article_lists_table FROM ?', [article_lists_table1]);

no_filter_list_create_table();
alasql('SELECT * INTO no_filter_list_table FROM ?', [no_filter_list_table1]);

article_lists_table_tag_table_create_table();
tag_create_table();

// https://github.com/AlaSQL/alasql/wiki/How-to-insert-data-into-the-table#how-to-insert-data-into-the-table
const tag_sample1 = [
    {id: 1, article_lists_table_tag_table_id: 1, tag: 'FOO1'},
    {id: 2, article_lists_table_tag_table_id: 1, tag: 'FOO2'},
    {id: 3, article_lists_table_tag_table_id: 1, tag: 'FOO3'},
];
alasql('SELECT * INTO tag_table FROM ?', [tag_sample1]);


// alasql(`CREATE TABLE IF NOT EXISTS article_lists_table_tag_table (
// id INT PRIMARY KEY,
// article_lists_table_id INT,
// tag_table_id INT)`);

const article_lists_table_tag_table_sample1 = [
    {id: 1, no_filter_list_table_id:1, tag_table_id:1},
    {id: 2, no_filter_list_table_id:1, tag_table_id:2},
    {id: 3, no_filter_list_table_id:1, tag_table_id:3},
];
alasql('SELECT * INTO article_lists_table_tag_table FROM ?', [article_lists_table_tag_table_sample1]);



comment_create_table();
const comment_sample1 = [
{id: 1, no_filter_list_table_id: 1, comment: 'FOO IS BAR' },
{id: 2, no_filter_list_table_id: 1, comment: 'BAR IS BUZ' },
{id: 3, no_filter_list_table_id: 1, comment: 'BUZ IS QUX' },
]
alasql('SELECT * INTO comment_table FROM ?', [comment_sample1]);

// https://stackoverflow.com/a/832589
// SELECT *
// FROM A_TABLE
// JOIN CROSS_TABLE
//     ON
//         A_TABLE.id = CROSS_TABLE.A_TABLE_id
// JOIN B_TABLE
//     ON
//         CROSS_TABLE.B_TABLE_id = B_TABLE.id

// A no_filter_list_table
// B tag_table
// CROSS article_lists_table_tag_table

// SELECT *
// FROM no_filter_list_table
// JOIN article_lists_table_tag_table
//     ON
//         no_filter_list_table.id = article_lists_table_tag_table.no_filter_list_table_id
// JOIN tag_table
//     ON
//         article_lists_table_tag_table.tag_table_id = tag_table.id

const query1_1 = `SELECT *
FROM no_filter_list_table
JOIN article_lists_table_tag_table
    ON
        no_filter_list_table.id = article_lists_table_tag_table.no_filter_list_table_id
JOIN tag_table
    ON
        article_lists_table_tag_table.tag_table_id = tag_table.id`;


console.table(alasql(query1_1));
console.table(alasql(query1_1).map(RECORD=>RECORD.tag));

const query2 = `SELECT *
FROM no_filter_list_table
JOIN comment_table
ON no_filter_list_table.id = comment_table.no_filter_list_table_id`;
console.table(alasql(query2));
console.table(alasql(query2).map(RECORD=>RECORD.comment));

</script>
</body>
</html>